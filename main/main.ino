#include <EspMQTTClient.h>

/*=============================================================================
Copyright Mickey
=============================================================================*/
/*!
@file   main.ino
@brief  main file of the iot_gateway
@author Mickey
@date   2021.7.28
@note

Description:
*/

/*=============================================================================
System Includes
=============================================================================*/

/*=============================================================================
Local Includes
=============================================================================*/

#include "http_server.h"
#include "esp8266_global.h"

/*=============================================================================
Definitions
=============================================================================*/

/*=============================================================================
Static Variables
=============================================================================*/

/*=============================================================================
Global Variables
=============================================================================*/

u32 led_flash_timestamp_ms    = 0;
u32 sonar_update_timestamp_ms = 0;

/*=============================================================================
Static Prototypes
=============================================================================*/

/*=============================================================================
Function Definitions
=============================================================================*/

/*===========================================================================*/

void setup()
{
  delay(100);

  /*-----------------------------------------------------------------------------
   Power On Initialisation
  -----------------------------------------------------------------------------*/
  Serial.begin(115200);

  /* Init GPIOs */
  GPIO_Initialise();

  LOG( DBG_P, "ESP8266 Iot gateway starting, version %s\n", SW_REVISION );

  /*-----------------------------------------------------------------------------
   System Initialisation
  -----------------------------------------------------------------------------*/

  /* Clean all the status */
  memset( &My_Status, 0 ,sizeof(MY_STATUS_RECORD) );

  /* Init all local configs */
  My_Config_Initialise();

  /* Init wifi configs */
  Wifi_Initialise();

  /* Init the HTTP server */
  http_server_init();

  /* Init sonar HC-SR04 */
  SR04_Initialise();

  /*---------------------------------------------------------------------------*/

}

/*===========================================================================*/

void loop()
{
  /* Flash LED */
  if ( (millis() - led_flash_timestamp_ms ) > 1000 )
  {
    led_flash_timestamp_ms = millis();
    int led_state = digitalRead(GPIO_LED_BLUE);
    digitalWrite(GPIO_LED_BLUE, !led_state);
  }

  /* Update sonar */
  if ( (millis() - sonar_update_timestamp_ms ) > 1000 )
  {
    sonar_update_timestamp_ms = millis();
    SR04_Get_Distance();
  }

  http_handle_client();
}
